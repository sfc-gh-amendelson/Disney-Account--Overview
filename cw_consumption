CREATE OR REPLACE DYNAMIC TABLE TEMP.AMENDELSON.DISNEY_CW_CONSUMPTION
    TARGET_LAG = '1 day'
    WAREHOUSE = SNOWHOUSE
AS
WITH disney_accounts AS (
    SELECT DISTINCT 
        SNOWFLAKE_ACCOUNT_ID, 
        SNOWFLAKE_ACCOUNT_NAME,
        ORGANIZATION_NAME,
        ORGANIZATION_ID,
        SNOWFLAKE_DEPLOYMENT,
        SALESFORCE_ACCOUNT_NAME,
        SALESFORCE_ACCOUNT_ID
    FROM SNOWSCIENCE.DIMENSIONS.DIM_ACCOUNTS_HISTORY 
    WHERE SALESFORCE_ACCOUNT_NAME = 'Disney Entertainment, ESPN Product & Technology'
),
warehouse_names AS (
    SELECT ID as WAREHOUSE_ID, NAME as WAREHOUSE_NAME, ACCOUNT_ID, 'va' as deployment FROM SNOWHOUSE_IMPORT.VA.WAREHOUSE_ETL_V
),
warehouse_metering AS (
    SELECT ACCOUNT_ID, ENTITY_ID as WAREHOUSE_ID, DATE_TRUNC('month', USAGE_TIME)::DATE as MONTH, SUM(CREDITS) as CREDITS
    FROM METERING_BY_HOUR_VA.METERING.WAREHOUSE_METERING 
    WHERE USAGE_TIME >= DATEADD('year', -2, CURRENT_DATE())
    GROUP BY ACCOUNT_ID, ENTITY_ID, DATE_TRUNC('month', USAGE_TIME)
),
target_warehouses AS (
    SELECT column1 as WAREHOUSE_NAME FROM VALUES
    ('PRODTECH_CW_ADHOC_POWER_WH'),('PRODTECH_CW_SERVICE_4XL_WH'),('PRODTECH_CW_LOOKER_ADHOC_WH'),('PRODTECH_CW_SERVICE_WH'),('PRODTECH_CW_SERVICE_POWER_WH'),('PRODTECH_CW_ADHOC_WH'),('PRODTECH_CW_DEV_ADHOC_3XL_WH'),('PRODTECH_CW_DEV_ADHOC_WH'),('PRODTECH_CW_DEV_SERVICE_WH'),
    ('CONTENT_CW_LOOKER_ADHOC_2XL_WH'),('CONTENT_CW_ADHOC_3XL_WH'),('CONTENT_CW_BACKFILL_2XL_WH'),('CONTENT_CW_ADHOC_WH'),('CONTENT_CW_SERVICE_WH'),('CONTENT_CW_DEV_ADHOC_3XL_WH'),('CONTENT_CW_DEV_SERVICE_WH'),('CONTENT_CW_DEV_ADHOC_WH'),('CONTENT_CW_DEV_LOOKER_ADHOC_2XL_WH'),
    ('LIFECYCLE_DECISION_SCIENCE_CW_SERVICE_WH'),('LIFECYCLE_DECISION_SCIENCE_CW_ADHOC_3X_WH'),('LIFECYCLE_DECISION_SCIENCE_CW_DEV_SERVICE_WH'),('LIFECYCLE_DECISION_SCIENCE_CW_DEV_ADHOC_WH'),
    ('SUBSCRIBER_CW_LOOKER_ADHOC_WH'),('SUBSCRIBER_CW_DEV_SERVICE_WH'),('SUBSCRIBER_CW_SERVICE_WH'),('SUBSCRIBER_CW_ADHOC_WH'),('SUBSCRIBER_CW_DEV_ADHOC_WH'),
    ('RETENTION_CW_ADHOC_WH'),('RETENTION_CW_ADHOC_3XL_WH'),('RETENTION_CW_SERVICE_3XL_WH'),('RETENTION_CW_LOOKER_ADHOC_WH'),('RETENTION_CW_SERVICE_WH'),('RETENTION_CW_FOUNDATIONAL_SERVICE_WH'),('RETENTION_CW_DEV_SERVICE_WH'),('RETENTION_CW_DEV_ADHOC_WH'),('RETENTION_CW_SERVICE_4XL_WH'),
    ('ENGAGEMENT_CW_SERVICE_WH'),('ENGAGEMENT_CW_AIRFLOW_SERVICE_4XL_WH'),('ENGAGEMENT_CW_ADHOC_3XL_WH'),('ENGAGEMENT_CW_DEV_ADHOC_3XL_WH'),('ENGAGEMENT_CW_LOOKER_ADHOC_WH'),('ENGAGEMENT_CW_AIRFLOW_SERVICE_3XL_WH'),('ENGAGEMENT_CW_SERVICE_2XL_WH'),('ENGAGEMENT_CW_ADHOC_WH'),('ENGAGEMENT_CW_DEV_ADHOC_WH')
)
SELECT 
    TO_CHAR(m.MONTH, 'YYYY-MM-DD') as MONTH,
    CASE 
        WHEN wn.WAREHOUSE_NAME LIKE 'PRODTECH_%' THEN 'PRODTECH'
        WHEN wn.WAREHOUSE_NAME LIKE 'CONTENT_%' THEN 'CONTENT'
        WHEN wn.WAREHOUSE_NAME LIKE 'LIFECYCLE_DECISION_SCIENCE_%' THEN 'LIFECYCLE_DECISION_SCIENCE'
        WHEN wn.WAREHOUSE_NAME LIKE 'SUBSCRIBER_%' THEN 'SUBSCRIBER'
        WHEN wn.WAREHOUSE_NAME LIKE 'RETENTION_%' THEN 'RETENTION'
        WHEN wn.WAREHOUSE_NAME LIKE 'ENGAGEMENT_%' THEN 'ENGAGEMENT'
    END as TEAM,
    wn.WAREHOUSE_NAME,
    m.WAREHOUSE_ID,
    da.SNOWFLAKE_ACCOUNT_NAME,
    da.SNOWFLAKE_ACCOUNT_ID,
    da.ORGANIZATION_NAME,
    da.ORGANIZATION_ID,
    da.SNOWFLAKE_DEPLOYMENT,
    da.SALESFORCE_ACCOUNT_NAME,
    da.SALESFORCE_ACCOUNT_ID,
    ROUND(m.CREDITS, 2) as CREDITS,
    ROUND(m.CREDITS * 1.67, 2) as TOTAL_CONSUMPTION_DOLLARS
FROM warehouse_metering m
JOIN disney_accounts da ON m.ACCOUNT_ID = da.SNOWFLAKE_ACCOUNT_ID
JOIN warehouse_names wn ON m.WAREHOUSE_ID = wn.WAREHOUSE_ID AND m.ACCOUNT_ID = wn.ACCOUNT_ID
JOIN target_warehouses tw ON wn.WAREHOUSE_NAME = tw.WAREHOUSE_NAME
